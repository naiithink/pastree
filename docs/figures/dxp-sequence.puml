@startuml
!pragma teoz true
skinparam monochrome true
skinparam defaultFontName Courier

title DXP Sequence
mainframe **sd** DXPSequence

participant "ps:Sender" as Sender
participant "ps:Recipient" as Recipient

autonumber
activate Sender

' opt 0
opt Recipient requests to retrieve a directory tree

Recipient -> Sender: PULL <PATH>

' opt 0
end

Sender -> Sender: Generate cookie and token
Sender -> Recipient: PUSH <DIR_NAME>\nToken: <TOKEN>\n[Request to transfer a tree\nrooted at <DIR_NAME>]

activate Recipient

Recipient -> Recipient: Remember token

' alt 0
alt Recipient agrees to receive

Recipient --> Sender: 1000 READY\nToken: <TOKEN>\n[Ready to receive]
Sender -> Sender: Verify then renew token
Sender -> Recipient: POLL\nCookie: <COOKIE>\nToken: <TOKEN>\n[Send cookie]
Recipient -> Recipient: Remember cookie and update token

' loop 0
loop

Recipient --> Sender: PICK <COOKIE>\nToken: <TOKEN>\n[Get next node]

' break 0
break Either cookie not found\nor cookie is INVALID

Sender ->> Recipient: 74 EBADMSG\n[Refuse PICK request\nthen close connection]

' break 0
end

Sender -> Sender: Verify token
Sender -> Sender: Accumulate Eng checksum
Sender -> Sender: Determine next node

' break 1
break Next node does not exist

Sender ->> Recipient: 2000 DONE\nDigest: <CHANG_DIGEST>\n[Send node and Chang checksum,\nthen close connection]
Recipient -> Recipient: Forget cookie and token
Recipient -> Recipient: Accumulate Chang checksum
Recipient -> Recipient: Compare Eng and Chang checksum

' break 1
end

Sender -> Sender: Renew token
Sender -> Recipient: 2001 MORE\nToken: <TOKEN>\n[Send node and tell next node exists]
Recipient -> Recipient: Update token
Recipient -> Recipient: Accumulate Chang checksum

' loop 0
end

' alt 0
else Recipient declines to receive

Recipient --> Sender: 1001 DECLINED\nToken: <TOKEN>\n[Refuse request then close connection]

'alt 0
end

Recipient -> Recipient: Terminate

deactivate Recipient
deactivate Sender
@enduml
